<%
[result|tail] = String.split(@context,"\n")

message = Enum.join(tail,"\n")


misstypes =
if @misstypes do
@misstypes
|> String.replace(" $", "（スペース）$")
|> String.split("\n")
|> Enum.map(&String.split(&1, "$ ", trim: true))
|> Enum.sort(&(List.last(&1)>= List.last(&2)))
else
[]
end
stage_link = "/game/stage/"<>"#{@id}/#{@area}"
again_link = "/game/main/"<>"#{@id}/#{@area}/#{@stage}"
{next,next_link} =
if @stage == "1" do
    {"次のステージへ","/game/main/"<>"#{@id}/#{@area}/2"}
else
    if @area != "4" do
        {"次のエリアへ","/game/stage/"<>"#{@id}/#{String.to_integer(@area) + 1}"}
    else
        {"タイトルに戻る","/game/start/"}
    end
end
%>



<div class="wrapper-finish">
    <h1 class="title-finish"><%="エリア#{@area} ステージ#{@stage} "<>result%></h1>

    <div class="tables">
        <div class="result-table table1">
            <table>
                <tr>
                    <td>経験値:</td>
                    <td><%= @get_exp%>pt</td>
                </tr>
                <tr>
                    <td>正解数:</td>
                    <td> <%= @count %> </td>
                </tr>
                <tr>
                    <td>クリアタイム:</td>
                    <td> <%= message %> </td>
                </tr>
                <tr>
                    <td>ミス:</td>
                    <td><%= @error %>回</td>
                </tr>
                <tr>
                    <td>レベル:</td>
                    <td><%= @level%></td>
                </tr>
            </table>
        </div>
        <div class="result-table">
            <table>
                <tr>
                    <td>苦手なキー:</td>
                    <td></td>
                </tr>
                <%= for misstype <- misstypes do %>
                    <tr>
                        <td><%= List.first(misstype) %></td>
                        <td><%= List.last(misstype) %>回</td>
                    </tr>
                <% end %>
            </table>
        </div>
    </div>

    <table class="functions">

        <tr>
            <th>お題の例文</th>
            <th>実行結果</th>
        </tr>
        <%= for function <- @functions do %>
            <tr>
                <td><%= List.first(function) %></td>
                <%= if List.last(function) != "" do %>
                    <td><%= List.last(function) %></td>
                <% end %>
            </tr>
        <% end %>
    </table>


    <div class="buttons-finish">
        <%= button "ステージ選択に戻る", to: stage_link, method: :get%>
        <%= button "もう一度挑戦する", to: again_link, method: :get%>
        <%= if @result == :completed do%>
            <%= button next, to: next_link, method: :get%>
        <% end %>
    </div>
</div>



<audio autoplay loop id="audio">
    <source src= "https://wingless-seraph.net/material/Epilogue.mp3" type="audio/mp3">
</audio>
<audio id="click">
    <source src= "https://wingless-seraph.net/se/kettei-01.wav" type="audio/wav">
</audio>
